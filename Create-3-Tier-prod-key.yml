---
- hosts: tag_AnsibleGroup_bastion
  name: Fetch Private Keys
  gather_facts: true
  become: yes

  tasks:
  - name: Install python-pip
    yum:
      name: python-pip
      state: latest

  - name: Install Ansible tower CLI
    pip:
      name: ansible-tower-cli

  - name: Inject keys into ansible Tower
    tower_credential:
      name: Three_Tier_Prod_Key
      state: present
      organization: Default
      tower_host: tower1.9748.example.opentlc.com
      tower_username: admin
      tower_password: r3dh4t1!
      kind: ssh
      username: ec2-user
      ssh_key_data: "/root/.ssh/{{ hostvars[inventory_hostname]['ec2_tag_Project'] | regex_replace('three-tier-app-','') }}key.pem"
